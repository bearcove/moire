# Storage And Ingest Spec

Status: todo
Owner: wg-storage-ingest
Scope: `crates/peeps-web`

## Goal

Persist each received `ProcessDump` into immutable graph snapshots keyed by `seq`.

## Ingest contract (v1)

`peeps-web` accepts framed event payloads:

- frame header: 4-byte big-endian unsigned length
- frame body: UTF-8 JSON `ProcessDump`

Error handling:
- reject frames > configured max (default 128 MiB)
- invalid UTF-8: close connection with reason
- invalid JSON/shape: log + continue connection

## SQLite schema (v1)

```sql
CREATE TABLE nodes (
  seq        INTEGER NOT NULL,
  id         TEXT    NOT NULL,
  kind       TEXT    NOT NULL,
  process    TEXT    NOT NULL,
  attrs_json TEXT    NOT NULL,
  PRIMARY KEY (seq, id)
);

CREATE TABLE edges (
  seq        INTEGER NOT NULL,
  src_id     TEXT    NOT NULL,
  dst_id     TEXT    NOT NULL,
  kind       TEXT    NOT NULL,
  attrs_json TEXT    NOT NULL,
  PRIMARY KEY (seq, src_id, dst_id, kind)
);

CREATE INDEX idx_nodes_seq_kind    ON nodes(seq, kind);
CREATE INDEX idx_nodes_seq_process ON nodes(seq, process);
CREATE INDEX idx_edges_seq_src     ON edges(seq, src_id);
CREATE INDEX idx_edges_seq_dst     ON edges(seq, dst_id);
CREATE INDEX idx_edges_seq_kind    ON edges(seq, kind);
```

## Snapshot write semantics

- `seq` is monotonic global sequence generated by server.
- Each incoming dump produces a new `seq` snapshot row set.
- Snapshot write is atomic (single transaction):
  - all node/edge rows for that snapshot commit together
  - on failure, rollback entire snapshot

## Required runtime settings

- WAL mode
- sane busy timeout
- single writer path (or write queue) to avoid lock contention

## Data retention policy (v1)

- Keep latest N snapshots (default N=500).
- Evict older snapshots with transactional delete:
  - delete from `edges` where `seq` < cutoff
  - delete from `nodes` where `seq` < cutoff

## Acceptance criteria

1. Instrumented processes can push framed payloads accepted by `peeps-web`.
2. For each accepted frame, a new `seq` is materialized in both `nodes` and `edges`.
3. Crash during ingest does not leave partial snapshot rows.
